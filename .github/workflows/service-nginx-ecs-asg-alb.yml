name: 'Service: nginx-ecs-asg-alb'

on: push
    # paths:
    #   - kloud/dev/eu-west-1/nginx-ecs-asg-alb/**

env:
  AWS_ACCOUNT_ID : "016272825626"
  AWS_REGION : "eu-west-1"
  ENVIRONMENT : "dev"

permissions:
  id-token: write
  contents: read

jobs:
  terragrunt:
    runs-on: ubuntu-latest
    environment:
        name: ${{ env.ENVIRONMENT }}
    steps:
    - name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/terragrunt-github-ci
        role-session-name: terragrunt-ci
        aws-region: ${{ env.AWS_REGION }}
    - uses: actions/checkout@v3
    - name: Setup Terraform & Terragrunt
      run: |
        brew install tfenv warrensbox/tap/tgswitch
        tfenv install
        tgswitch
    - name: terragrunt fmt
      id: fmt
      run: terragrunt fmt -check -diff
      working-directory: kloud/dev/eu-west-1/nginx-ecs-asg-alb
    - name: terragrunt init
      id: init
      run: terragrunt init
      working-directory: kloud/dev/eu-west-1/nginx-ecs-asg-alb
    - name: terragrunt validate
      id: validate
      run: terragrunt validate
      working-directory: kloud/dev/eu-west-1/nginx-ecs-asg-alb
    - name: terragrunt plan
      id: plan
      if: ${{ github.event_name != 'pull_request' }}
      run: terragrunt plan
      working-directory: kloud/dev/eu-west-1/nginx-ecs-asg-alb
      continue-on-error: true
    - name: terragrunt apply
      id: deploy
      if: ${{ github.ref != 'refs/heads/main' }} && ${{ github.event_name != 'push' }}
      run: terragrunt apply
      working-directory: kloud/dev/eu-west-1/nginx-ecs-asg-alb
      
